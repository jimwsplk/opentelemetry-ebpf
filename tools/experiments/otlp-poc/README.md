# This directory is for proof of concept code sending metrics (and logs) via OTLP (gRPC and HTTP) to the opentelemetry-collector.

## OTLP gRPC clients

NOTE: These do not currently build in benv because the gRPC and protobuf-compiler/protoc versions are too old.

NOTE : The `$EBPF_NET_SRC/tools/examples/otlp-poc/grpc/opentelemetry` directory is currently from a recursive copy
of `opentelemetry-proto/gen/cpp/opentelemetry` generated by:

  ``` shell
  cd /tmp
  git clone https://github.com/open-telemetry/opentelemetry-proto.git -b v0.14.0
  cd opentelemetry-proto
  make gen-cpp
  ```

### To build OTLP gRPC POC clients on a linux system:

1) install prerequisites for building grpc
``` shell
cd /tmp
export MY_INSTALL_DIR=/usr
wget -q -O cmake-linux.sh https://github.com/Kitware/CMake/releases/download/v3.19.6/cmake-3.19.6-Linux-x86_64.sh
sudo sh cmake-linux.sh -- --skip-license --prefix=$MY_INSTALL_DIR
rm cmake-linux.sh
```
``` shell
sudo apt install -y build-essential autoconf libtool pkg-config
```

2) build and install grpc
``` shell
cd /tmp
# use grpc v1.41.x so it uses same protobuf-compiler version as opentelemetry-proto v0.14.0
git clone --recurse-submodules -b v1.41.x https://github.com/grpc/grpc
cd grpc
mkdir -p cmake/build
pushd cmake/build
cmake -DgRPC_INSTALL=ON -DgRPC_BUILD_TESTS=OFF ../..
make -j 17
sudo make install
```

3) build the OTLP gRPC POC clients
``` shell
cd $EBPF_NET_SRC/tools/experiments/otlp-poc/grpc
cmake .
make -j17
```

4) run the Splunk opentelemetry collector
``` shell
docker run --rm -e SPLUNK_ACCESS_TOKEN=12345 -e SPLUNK_REALM=us0 -e SPLUNK_CONFIG=/etc/otel/config.yaml -p 4317:4317 -p 4318:4318 -p 8888:8888 -p 13133:13133 -v ~/work/jmwfm1/dev/devbox/source/splunk-otelcol-config.yaml:/etc/otel/config.yaml -v /tmp/otel.log:/var/log/otel.log --name otelcol quay.io/signalfx/splunk-otel-collector:latest
```
OR
``` shell
$EBPF_NET_SRC/dev/devbox/source/otelcol-gateway.sh --splunk
```

5) in another window run the gRPC POC clients
``` shell
cd $EBPF_NET_SRC/tools/grpc-otlp-poc
./otlp-grpc-logs-client               # you should see log information in the splunk-otel window
./otlp-grpc-metrics-client            # you should see metric information in the splunk-otel window
```

## OTLP HTTP client

1) (inside benv) Build the OTLP HTTP POC client
``` shell
benv -s
../build.sh --cmake
../build.sh otlp-http-metrics-client
```

2) (outside of benv) run the Splunk opentelemetry collector - same as step 4, above

3) (outside of benv) in another window run the HTTP POC client
``` shell
/tmp/flowmill-benv-out/tools/experiments/otlp-poc/http/otlp-http-metrics-client
```
